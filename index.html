<!-- 顏慈瑩2025.10.5 / Plan-Only + 30秒粒度 / 無最上方副標 -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dual‑OR Scheduler — v2.7 (Plan‑Only, OR Util = I+O+W, 30s step)</title>
  <style>
    :root{
      --day-mins: 570;            /* 7:30–17:00 */
      --px-per-min: 2;            /* timeline scale */
      --lane-h: 48px;             /* lane height */
      --gap: 10px;                /* lane gap */

      --bg: #f6f7fb; --text:#1f2937; --muted:#64748b; --card:#fff; --line:#e7e9f0; --line-2:#eef0f6;
      --brand:#0f172a; --primary:#2563eb; --primary-2:#6366f1;

      /* Base palette */
      --green:#10b981; --green-700:#047857; --amber:#eab308; --amber-700:#b45309; --blue:#3b82f6; --blue-700:#1d4ed8;

      /* KPI colors */
      --idle-ok:#002d74; --idle-high:#f3c300;

      /* === Stage colors === */
      --col-S:#e97132; --col-S-b:#c2410c; --col-S-t:#fff;  /* Setup */
      --col-I:#92d050; --col-I-b:#6aa84f; --col-I-t:#fff;  /* Induction */
      --col-O:#c00000; --col-O-b:#7f0000; --col-O-t:#fff;  /* Operation */
      --col-W:#00b0f0; --col-W-b:#0077a3; --col-W-t:#fff;  /* Wake-up */
      --col-C:#0b76a0; --col-C-b:#064d66; --col-C-t:#fff;  /* Clean-up */
      --col-F:#d86ecc; --col-F-b:#a8329b; --col-F-t:#fff;  /* Family comm */
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }

    header{ background:var(--brand); color:#fff; padding:16px 20px; }
    header h1{ margin:0; font-size:20px; font-weight:800; }
    header .sub{ margin-top:6px; font-size:12px; opacity:.9 }

    .container{ padding:16px 20px; display:grid; grid-template-columns:minmax(320px,420px) minmax(0,1fr); gap:16px; }
    @media (max-width:1100px){ .container{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); min-width:0; }
    .card h2{ margin:0; padding:12px 14px; font-size:16px; border-bottom:1px solid var(--line-2); }
    .section{ padding:12px 14px; }

    .muted{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #e2e8f0; background:#f1f5f9; }

    input[type="text"],input[type="number"],input[type="time"],select{ width:100%; padding:8px 10px; border:1px solid #d9dce7; border-radius:8px; background:#fff; font-size:13px; }
    label{ font-size:12px; color:#475569; display:block; margin-bottom:4px; }
    .stack>div{ margin-top:10px; }
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:720px){ .form-grid{ grid-template-columns:1fr; } }

    .checkbox-row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; margin-top:8px; }
    .checkbox-row label{ display:flex; align-items:center; gap:6px; font-size:12px; }
    input[type="checkbox"]{ transform:scale(1.1); }

    .btn-row{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:8px 10px; border-radius:8px; border:1px solid #d9dce7; background:#fff; cursor:pointer; font-weight:600; font-size:13px; text-align:center; }
    .btn.primary{ background: var(--primary); border-color: var(--primary); color:#fff; }
    .btn.ghost{ background:transparent; }

    .kpis{ display:grid; grid-template-columns: repeat(2,1fr); gap:8px; margin-bottom:10px; }
    .kpi{ background:#4e6d9e; color:#fff; border-radius:10px; padding:10px 12px; }
    .kpi small{ opacity:.85; display:block; font-weight:500; }
    .kpi.idle{ background: var(--idle-ok); }
    .kpi.idle.high{ background: var(--idle-high); color:#000; }

    .legend{ padding:6px 14px; font-size:12px; color:#475569; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{ display:inline-block; width:14px; height:10px; border-radius:3px; border:1px solid #cbd5e1; }

    .gantt-wrap{ padding:12px 14px; display:grid; grid-template-columns:160px 1fr; gap:12px; align-items:start; max-width:100%; }
    .gantt{ position:relative; width:100%; overflow-x:auto; border:1px dashed #cbd5e1; background:#fcfdff; border-radius:10px; padding:12px; }
    .gantt::-webkit-scrollbar{ height: 10px; }
    .gantt::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius: 999px; }

    .left-col-outer{ position: sticky; left: 0; align-self:start; z-index:6; }
    .label-row{ height: var(--lane-h); display:flex; align-items:center; color:#475569; font-size:12px; border-right:1px solid #e2e8f0; padding-left:10px; background:#f8fafc; margin-bottom: var(--gap); border-radius:8px 0 0 8px; }

    .gantt-inner{ position: relative; }
    .scale{ position:sticky; top:0; z-index:2; height:20px; margin-bottom:6px; white-space:nowrap; background:#fcfdff; }
    .tick{ display:inline-block; height:100%; border-left:1px solid #e2e8f0; color:#64748b; font-size:11px; text-align:left; padding-left:2px; box-sizing:content-box; }

    .lane{ position:relative; height:var(--lane-h); border:1px solid #e2e8f0; background:#f8fafc; border-radius:8px; margin-bottom:var(--gap); }

    .block{ position:absolute; top:5px; height: calc(var(--lane-h) - 10px); border-radius:6px; overflow:hidden; }
    .block .label{ font-size:12px; font-weight:700; padding:2px 6px; }
    .block.locked{ outline:2px dashed rgba(0,0,0,.15); }

    .block.S{ background:var(--col-S); border:1px solid var(--col-S-b); color:var(--col-S-t);} /* Setup */
    .block.I{ background:var(--col-I); border:1px solid var(--col-I-b); color:var(--col-I-t);} /* Induction */
    .block.O{ background:var(--col-O); border:1px solid var(--col-O-b); color:var(--col-O-t);} /* Operation */
    .block.W{ background:var(--col-W); border:1px solid var(--col-W-b); color:var(--col-W-t);} /* Wake-up */
    .block.C{ background:var(--col-C); border:1px solid var(--col-C-b); color:var(--col-C-t);} /* Clean-up */
    .block.F{ background:var(--col-F); border:1px solid var(--col-F-b); color:var(--col-F-t);} /* Family comm */

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ padding:8px; border-bottom:1px solid var(--line-2); text-align:left; }
    th{ color:#475569; font-weight:700; background:#f8fafc; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    .notice{ margin-top:8px; font-size:12px; color:#b45309; display:none; }
    .notice.show{ display:block; }
  </style>
</head>
<body>
  <header>
    <h1>Dual‑OR Scheduler</h1>
    <!-- 已移除最上方副標資訊列 -->
  </header>

  <div class="container">
    <!-- LEFT: Controls -->
    <div class="card">
      <h2>Controls</h2>

      <div class="section kpis">
        <div class="kpi">
          <small>Planned so far</small>
          <div style="font-size:22px; font-weight:800" id="kpiCount">0</div>
          <div style="font-size:12px" id="kpiBreak">Confirmed 0 · Tentative 0 · Emerg 0</div>
          <div style="font-size:11px; opacity:.85" id="kpiUpdated">Last updated —</div>
        </div>
        <div class="kpi idle" id="kpiIdleCard">
          <small>Surgeon downtime (est.)</small>
          <div style="font-size:22px; font-weight:800" id="kpiIdle">0 min</div>
          <div style="font-size:12px" id="kpiUtil">OR1 — 0% · OR2 — 0%</div>
          <div style="font-size:11px; opacity:.85">Doctor downtime = 570 − OTIME − FTIME · OR Util = (I+O+W)/570</div>
        </div>
      </div>

      <h2>Add / Edit Case</h2>
      <div class="section">
        <div class="stack" aria-label="primary fields">
          <div>
            <label for="caseId">Case ID (auto if blank)</label>
            <input type="text" id="caseId" placeholder="e.g., C-101" />
          </div>
          <div>
            <label for="oMin">Operation (O) min *</label>
            <input type="number" id="oMin" min="10" step="0.5" placeholder="e.g., 60" />
          </div>
          <div>
            <label for="winStart">Earliest start (HH:MM, optional)</label>
            <input type="time" id="winStart" min="07:30" max="17:00" step="300" placeholder="e.g., 08:30" />
          </div>
        </div>

        <div class="form-grid" style="margin-top:10px">
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option value="confirmed">Confirmed</option>
              <option value="tentative">Tentative</option>
              <option value="emergency">Emergency hold</option>
            </select>
          </div>
          <div>
            <label for="priority">Priority</label>
            <select id="priority">
              <option>Elective</option>
              <option>Emergency</option>
            </select>
          </div>
          <div>
            <label for="lockSel">Lock</label>
            <select id="lockSel">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="checkbox-row">
          <label><input type="checkbox" id="ovS"> Set up <input type="number" id="valS" min="0" step="0.5" placeholder="min" style="width:68px" disabled></label>
          <label><input type="checkbox" id="ovI"> Induction <input type="number" id="valI" min="0" step="0.5" placeholder="min" style="width:68px" disabled></label>
          <label><input type="checkbox" id="ovW"> Wake up <input type="number" id="valW" min="0" step="0.5" placeholder="min" style="width:68px" disabled></label>
          <label><input type="checkbox" id="ovC"> Clean up <input type="number" id="valC" min="0" step="0.5" placeholder="min" style="width:68px" disabled></label>
          <label><input type="checkbox" id="ovF"> Family comm. <input type="number" id="valF" min="0" step="0.5" placeholder="min" style="width:68px" disabled></label>
        </div>

        <div class="btn-row">
          <button class="btn primary" id="btnAdd">Add / Update Case</button>
          <button class="btn" id="btnClear">Clear Form</button>
          <button class="btn ghost" id="btnReopt">Re‑optimize</button>
        </div>
        <div style="margin-top:6px" class="muted">Defaults: S 7.5, I 20, W 20, C 7.5, F 10 (min).</div>
        <div id="notice" class="notice">⚠️ 有些個案無法排進視窗，試著解鎖、調整開始時間或時長。</div>
      </div>
    </div>

    <!-- RIGHT: Timeline & Table -->
    <div class="card">
      <h2>Schedule & Timeline</h2>
      <div class="legend">
        <span><span class="chip" style="background:var(--col-S);"></span> S</span>
        <span><span class="chip" style="background:var(--col-I);"></span> I</span>
        <span><span class="chip" style="background:var(--col-O);"></span> O</span>
        <span><span class="chip" style="background:var(--col-W);"></span> W</span>
        <span><span class="chip" style="background:var(--col-C);"></span> C</span>
        <span><span class="chip" style="background:var(--col-F);"></span> F (Doctor)</span>
      </div>
      <div class="gantt-wrap">
        <div id="gantt" class="gantt" role="region" aria-label="Timeline"></div>
      </div>

      <h2>Cases</h2>
      <div class="section">
        <table id="tbl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>O</th>
              <th>S/I/W/C/F</th>
              <th>Room</th>
              <th>Start</th>
              <th>Lock</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  const DAY_MINS = 570; // minutes in day window
  let PX = 2;           // pixels per minute (responsive)
  const defaults = { S: 7.5, I: 20, W: 20, C: 7.5, F: 10 };
  let cases = [];
  let seq = 1;          // plan only

  const $ = (id) => document.getElementById(id);
  const nowStr = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const clamp = (v, lo, hi) => Math.min(Math.max(v, lo), hi);
  const nnum = (v, fb) => { const n = parseFloat(v); return Number.isFinite(n) ? n : fb; };
  const safe = (x) => { const n = Number(x); return Number.isFinite(n) ? n : 0; };

  const START_H = 7, START_M = 30;
  function clockLabel(min){ const total = START_H*60 + START_M + min; const h = Math.floor(total/60), m = Math.round((total%60)*100)/100; const mm = String(Math.floor(m)).padStart(2,'0'); return `${h}:${mm}`; }
  function fmt(min){ return (min==null) ? '—' : clockLabel(min); }
  function toRelMinutes(t){ if(!t) return NaN; const [hh,mm] = t.split(':').map(Number); if(!Number.isFinite(hh)||!Number.isFinite(mm)) return NaN; const origin = START_H*60 + START_M; return hh*60 + mm - origin; }
  function toTimeInput(min){ if(min==null) return ''; const origin=START_H*60+START_M; const abs = origin + min; const h=Math.floor(abs/60), m=abs%60; return String(h).padStart(2,'0')+':'+String(Math.floor(m)).padStart(2,'0'); }

  // Durations helpers
  const durOR = (c) => safe(c.S) + safe(c.I) + safe(c.O) + safe(c.W) + safe(c.C); // OR occupancy (engineering)
  const durIOW = (c) => safe(c.I) + safe(c.O) + safe(c.W);                          // OR utilization (reporting)

  // Feasibility rules: Doctor O+F 不重疊；同一 OR 的 S/I/O/W/C 不重疊。
  function feasibleAt(c, start, room){
    const end = start + durOR(c);
    if(start < (c.winStart||0) || end > DAY_MINS) return false;

    const cOs = start + safe(c.S) + safe(c.I);
    const cOe = cOs + safe(c.O);
    const cFe = cOe + safe(c.F);

    // Doctor O+F no overlap
    for(const x of cases){
      if(x === c || x.start == null) continue;
      const xOs = x.start + safe(x.S) + safe(x.I);
      const xOe = xOs + safe(x.O);
      const xFe = xOe + safe(x.F);
      if(!(cFe <= xOs || xFe <= cOs)) return false;
    }

    // OR occupancy no overlap (S/I/O/W/C) in same room
    for(const x of cases){
      if(x === c || x.start == null || x.room !== room) continue;
      const b1s = start, b1e = end, b2s = x.start, b2e = x.start + durOR(x);
      if(!(b1e <= b2s || b2e <= b1s)) return false;
    }

    return true;
  }

  function placeEarliest(c, rooms=['OR1','OR2']){
    const step = 0.5; // 30秒粒度
    for(const room of rooms){
      for(let t = Math.max(0, c.winStart||0); t + durOR(c) <= DAY_MINS + 1e-9; t = Math.round((t + step)*2)/2){
        if(feasibleAt(c, t, room)){ c.start = t; c.room = room; return true; }
      }
    }
    return false;
  }

  function schedulePlan(){
    const locked = cases.filter(c=>c.locked);
    const unlocked = cases.filter(c=>!c.locked);

    locked.sort((a,b)=> (a.start ?? a.winStart ?? 0) - (b.start ?? b.winStart ?? 0));
    for(const c of locked){ if(c.start == null) placeEarliest(c); }

    for(const c of unlocked){ c.start = null; c.room = null; }
    unlocked.sort((a,b)=> (a.winStart ?? 0) - (b.winStart ?? 0));
    for(const c of unlocked){ placeEarliest(c); }
  }

  function reoptimize(){ schedulePlan(); render(); }

  // UI wiring (Plan only)
  ;['S','I','W','C','F'].forEach(k=>{ const ck=$('ov'+k), iv=$('val'+k); if(ck && iv){ ck.addEventListener('change', ()=>{ iv.disabled = !ck.checked; if(iv.disabled) iv.value=''; }); } });

  const addBtn = $('btnAdd');
  if(addBtn){ addBtn.onclick = ()=>{
    const idTxt = ($('caseId').value || '').trim() || `C-${String(seq++).padStart(3,'0')}`;
    const O = parseFloat($('oMin').value);
    if(!Number.isFinite(O) || O <= 0){ alert('Please enter a valid Operation time (minutes).'); return; }

    const S = $('ovS')?.checked ? nnum($('valS').value, defaults.S) : defaults.S;
    const I = $('ovI')?.checked ? nnum($('valI').value, defaults.I) : defaults.I;
    const W = $('ovW')?.checked ? nnum($('valW').value, defaults.W) : defaults.W;
    const C = $('ovC')?.checked ? nnum($('valC').value, defaults.C) : defaults.C;
    const F = $('ovF')?.checked ? nnum($('valF').value, defaults.F) : defaults.F;

    const status = $('status').value;
    const locked = $('lockSel').value === 'yes';
    const wsStr = $('winStart').value; const ws = toRelMinutes(wsStr);
    const winStart = Number.isFinite(ws) ? clamp(ws, 0, DAY_MINS) : 0;

    const idx = cases.findIndex(x=>x.id === idTxt);
    const data = { id:idTxt, O, S, I, W, C, F, status, locked, winStart };
    if(idx >= 0){ cases[idx] = Object.assign(cases[idx], data); }
    else { cases.push(Object.assign({ start:null, room:null }, data)); }

    reoptimize();
    clearForm();
  }; }

  const clearBtn = $('btnClear'); if(clearBtn){ clearBtn.onclick = clearForm; }
  const reoptBtn = $('btnReopt'); if(reoptBtn){ reoptBtn.onclick = reoptimize; }

  function clearForm(){
    ['caseId','oMin','winStart','valS','valI','valW','valC','valF'].forEach(id=>{ const n=$(id); if(n) n.value=''; });
    ['ovS','ovI','ovW','ovC','ovF'].forEach(id=>{ const c=$(id); if(c){ c.checked=false; const v=$(id.replace('ov','val')); if(v) v.disabled=true; }});
    if($('status')) $('status').value='confirmed';
    if($('priority')) $('priority').value='Elective';
    if($('lockSel')) $('lockSel').value='no';
  }

  // KPIs & Utilization
  function kpis(){
    const count = cases.filter(c=>['confirmed','tentative','emergency'].includes(c.status)).length;
    const conf  = cases.filter(c=>c.status==='confirmed').length;
    const tent  = cases.filter(c=>c.status==='tentative').length;
    const emerg = cases.filter(c=>c.status==='emergency').length;
    $('kpiCount').textContent = count;
    $('kpiBreak').textContent = `Confirmed ${conf} · Tentative ${tent} · Emerg ${emerg}`;
    $('kpiUpdated').textContent = `Last updated ${nowStr()}`;

    // Doctor downtime = 570 − OTIME − FTIME
    const Otime = cases.filter(c=>c.start!=null).reduce((sum,c)=> sum + safe(c.O), 0);
    const Ftime = cases.filter(c=>c.start!=null).reduce((sum,c)=> sum + safe(c.F), 0);
    const idle = clamp(DAY_MINS - Otime - Ftime, 0, DAY_MINS);
    $('kpiIdle').textContent = `${Math.round(idle)} min`;

    // OR utilization per room = (sum of I+O+W in that room) / DAY_MINS
    const occIOW = { OR1:0, OR2:0 };
    for(const c of cases){ if(c.start==null||!c.room) continue; occIOW[c.room] += durIOW(c); }
    const u1raw = cases.some(c=>c.room==='OR1') ? Math.round((occIOW.OR1/DAY_MINS)*100) : 0;
    const u2raw = cases.some(c=>c.room==='OR2') ? Math.round((occIOW.OR2/DAY_MINS)*100) : 0;
    const u1 = clamp(u1raw,0,100), u2 = clamp(u2raw,0,100);
    $('kpiUtil').textContent = `OR1 — ${u1}% · OR2 — ${u2}%`;

    const notice = $('notice'); if(notice){ notice.classList.toggle('show', cases.some(c=>c.start==null)); }
    const idleCard = document.getElementById('kpiIdleCard'); if(idleCard){ idleCard.classList.toggle('high', idle >= 60); }
  }

  // Gantt rendering
  function addBlock(kind, start, end, lane, id){
    if(end<=start) return;
    const div = document.createElement('div');
    div.className = `block ${kind}`;
    div.style.left = (start*PX)+'px';
    div.style.width = ((end-start)*PX)+'px';
    div.innerHTML = `<div class="label">${id} ${kind}</div>`;
    lane.appendChild(div);
  }

  function renderGantt(){
    const wrap = document.querySelector('.gantt-wrap');
    if(!wrap) return;

    wrap.innerHTML = '';
    const left = document.createElement('div'); left.id = 'ganttLabels'; left.className = 'left-col-outer'; wrap.appendChild(left);
    const g = document.createElement('div'); g.id = 'gantt'; g.className = 'gantt'; wrap.appendChild(g);

    const containerWidth = g.getBoundingClientRect().width || g.parentElement.getBoundingClientRect().width || 800;
    const available = containerWidth - 24;
    PX = Math.max(0.8, Math.min(2, available / Math.max(1, DAY_MINS)));

    const inner = document.createElement('div'); inner.className = 'gantt-inner'; inner.style.width = (DAY_MINS * PX) + 'px'; g.appendChild(inner);

    const scale = document.createElement('div'); scale.className='scale';
    const limit = DAY_MINS - (DAY_MINS % 60);
    for(let t = 0; t < limit; t += 60){
      const tick = document.createElement('div');
      tick.className='tick';
      tick.style.width = (60*PX)+'px';
      tick.textContent = clockLabel(t);
      scale.appendChild(tick);
    }
    const rem = DAY_MINS - limit;
    if(rem){ const last = document.createElement('div'); last.className='tick'; last.style.width=(rem*PX)+'px'; last.style.textAlign='right'; last.style.paddingRight='2px'; last.style.borderRight='1px solid #e2e8f0'; last.textContent=clockLabel(DAY_MINS); scale.appendChild(last); }
    inner.appendChild(scale);

    const spacer = document.createElement('div'); const padTop = parseFloat(getComputedStyle(g).paddingTop)||0; const scaleMargin = parseFloat(getComputedStyle(scale).marginBottom)||0; const spacerH = padTop + scale.offsetHeight + scaleMargin; spacer.style.height = spacerH + 'px'; left.appendChild(spacer);

    const lane1 = document.createElement('div'); lane1.className='lane';
    const lane2 = document.createElement('div'); lane2.className='lane';
    const laneDoc = document.createElement('div'); laneDoc.className='lane';
    inner.appendChild(lane1); inner.appendChild(lane2); inner.appendChild(laneDoc);

    ;['OR-1','OR-2','Doctor'].forEach(text=>{ const lr=document.createElement('div'); lr.className='label-row'; lr.textContent=text; left.appendChild(lr); });

    const endLine = document.createElement('div'); endLine.style.position='absolute'; endLine.style.left=(DAY_MINS*PX)+'px'; endLine.style.top=spacerH+'px'; endLine.style.bottom='0'; endLine.style.width='1px'; endLine.style.background='#e2e8f0'; inner.appendChild(endLine);

    for(const c of cases){
      if(c.start == null || !c.room) continue;
      const lane = c.room === 'OR1' ? lane1 : lane2;

      const sStart = c.start, sEnd = sStart + safe(c.S);
      const iStart = sEnd,    iEnd = iStart + safe(c.I);
      const oStart = iEnd,    oEnd = oStart + safe(c.O);
      const wStart = oEnd,    wEnd = wStart + safe(c.W);
      const cStart = wEnd,    cEnd = cStart + safe(c.C);

      addBlock('S', sStart, sEnd, lane, c.id);
      addBlock('I', iStart, iEnd, lane, c.id);
      addBlock('O', oStart, oEnd, lane, c.id);
      addBlock('W', wStart, wEnd, lane, c.id);
      addBlock('C', cStart, cEnd, lane, c.id);

      addBlock('O', oStart, oEnd, laneDoc, c.id);
      const fStart = oEnd, fEnd = fStart + safe(c.F);
      addBlock('F', fStart, fEnd, laneDoc, c.id);
    }
  }

  function render(){ renderTable(); renderGantt(); kpis(); }

  function renderTable(){
    const tbody = document.querySelector('#tbl tbody'); if(!tbody) return; tbody.innerHTML = ''; const frag = document.createDocumentFragment();
    for(const c of cases){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${c.id}</strong></td>
        <td><span class="badge">${c.status}</span></td>
        <td>${Math.round(safe(c.O))}</td>
        <td class="muted">${[c.S,c.I,c.W,c.C,c.F].map(x=>Number.isInteger(x)?x:x.toFixed(1)).join('/')}</td>
        <td>${c.room||'—'}</td>
        <td>${fmt(c.start)}</td>
        <td>${c.locked? '🔒' : ''}</td>
        <td class="right">
          <button class="btn" data-act="lock">${c.locked? 'Unlock':'Lock'}</button>
          <button class="btn" data-act="edit">Edit</button>
          <button class="btn" data-act="del">Delete</button>
        </td>`;

      tr.querySelector('[data-act="lock"]').onclick = ()=>{ c.locked = !c.locked; render(); };
      tr.querySelector('[data-act="edit"]').onclick = ()=>{
        $('caseId').value = c.id;
        $('oMin').value = c.O;
        $('status').value = c.status;
        $('lockSel').value = c.locked? 'yes':'no';
        $('winStart').value = (c.winStart != null) ? toTimeInput(c.winStart) : '';
        ;['S','I','W','C','F'].forEach(k=>{ const ck=$('ov'+k), iv=$('val'+k); if(ck&&iv){ ck.checked=true; iv.disabled=false; iv.value=c[k]; }});
      };
      tr.querySelector('[data-act="del"]').onclick = ()=>{ cases = cases.filter(x=>x.id !== c.id); render(); };

      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  (function seed(){
    const d = defaults;
    cases = [
      {id:'C-001', O:60, S:d.S, I:d.I, W:d.W, C:d.C, F:d.F, status:'confirmed', locked:true,  winStart:0,   start:null, room:null},
      {id:'C-002', O:45, S:d.S, I:d.I, W:d.W, C:d.C, F:d.F, status:'tentative', locked:false, winStart:0,   start:null, room:null},
      {id:'C-003', O:90, S:d.S, I:d.I, W:d.W, C:d.C, F:d.F, status:'confirmed', locked:false, winStart:60,  start:null, room:null}
    ];
    reoptimize();
  })();

  window.addEventListener('resize', render);
  </script>
</body>
</html>
